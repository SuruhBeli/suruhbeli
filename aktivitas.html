<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FB923C">
  <link rel="icon" href="ikon-512.png">
  <link rel="stylesheet" href="aktivitas.css">
<title>SuruhBeli - Aktivitas</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

</head>
<body>

<div class="scroll-header">Aktivitas Pesanan</div>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="aktif">Pesanan Aktif</div>
    <div class="tab" data-tab="diproses">Diproses</div>
    <div class="tab" data-tab="riwayat">Riwayat</div>
  </div>

  <div id="ordersContainer"></div>
</div>

<!-- POPUP -->
<div id="popupDetail" class="popup-overlay">
  <div class="receipt">
    <div id="popupContent"></div>
    <button class="close-btn" onclick="closePopup()">Tutup</button>
  </div>
</div>
<!-- POPUP ALERT CUSTOM -->
<div id="popupAlert" class="popup-overlay">
  <div class="confirm-card">
    
    <div class="confirm-left">
      <div id="popupAlertMessage" class="confirm-title">
        Pesan Alert
      </div>
    
      <div id="popupAlertSub" class="confirm-sub">
        Konfirmasi tindakan
      </div>
    
      <div class="confirm-buttons">
        <button id="popupCancel" class="btn-secondary">
          Batal
        </button>
        <button id="popupOk" class="btn-primary">
          OK
        </button>
      </div>
    </div>
    
    <!-- GAMBAR FRAME KANAN -->
    <img src="alert.png" class="confirm-img">

  </div>
</div>
<!-- NAVBAR FIXED BAWAH -->
<div class="navbar-bottom">
  <div class="nav-active-circle" id="navCircle"></div>

  <div class="nav-item" data-index="0" data-href="index.html">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
      <path d="M11.47 3.841a.75.75 0 0 1 1.06 0l8.69 8.69a.75.75 0 1 0 1.06-1.061l-8.689-8.69a2.25 2.25 0 0 0-3.182 0l-8.69 8.69a.75.75 0 1 0 1.061 1.06l8.69-8.689Z" />
      <path d="m12 5.432 8.159 8.159c.03.03.06.058.091.086v6.198c0 1.035-.84 1.875-1.875 1.875H15a.75.75 0 0 1-.75-.75v-4.5a.75.75 0 0 0-.75-.75h-3a.75.75 0 0 0-.75.75V21a.75.75 0 0 1-.75.75H5.625a1.875 1.875 0 0 1-1.875-1.875v-6.198a2.29 2.29 0 0 0 .091-.086L12 5.432Z" />
    </svg>

    <span>Home</span>
  </div>
  <div class="nav-item" data-index="1" data-href="aktivitas.html">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
      <path fill-rule="evenodd" d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6ZM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5Z" clip-rule="evenodd" />
      <path fill-rule="evenodd" d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375ZM6 12a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V12Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 15a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V15Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75ZM6 18a.75.75 0 0 1 .75-.75h.008a.75.75 0 0 1 .75.75v.008a.75.75 0 0 1-.75.75H6.75a.75.75 0 0 1-.75-.75V18Zm2.25 0a.75.75 0 0 1 .75-.75h3.75a.75.75 0 0 1 0 1.5H9a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" />
    </svg>

    <span>Pesanan</span>
  </div>
  <div class="nav-item" data-index="2" data-href="profil.html">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
      <path fill-rule="evenodd" d="M18.685 19.097A9.723 9.723 0 0 0 21.75 12c0-5.385-4.365-9.75-9.75-9.75S2.25 6.615 2.25 12a9.723 9.723 0 0 0 3.065 7.097A9.716 9.716 0 0 0 12 21.75a9.716 9.716 0 0 0 6.685-2.653Zm-12.54-1.285A7.486 7.486 0 0 1 12 15a7.486 7.486 0 0 1 5.855 2.812A8.224 8.224 0 0 1 12 20.25a8.224 8.224 0 0 1-5.855-2.438ZM15.75 9a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" clip-rule="evenodd" />
    </svg>

    <span>Profil</span>
  </div>
</div>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyByQl0BXZoSMzrULUNA6l7UVFQjXmvsdJE",
  authDomain: "suruhbeli-e8ae8.firebaseapp.com",
  projectId: "suruhbeli-e8ae8"
});

const auth = firebase.auth();
const db = firebase.firestore();
let currentUser = null;
let activeTab = 'aktif';

auth.onAuthStateChanged(async (user)=>{
  if(user){
    currentUser = user;
    loadOrders();
  }else{
    window.location.href = "index.html";
  }
});

document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activeTab = tab.dataset.tab;
    loadOrders();
  });
});

async function loadOrders(){
  if(!currentUser) return;
  const container = document.getElementById('ordersContainer');
  container.innerHTML = 'Memuat pesanan...';

  try{
    const snapshot = await db.collection("orders")
      .where("userId","==",currentUser.uid)
      .get();

    const orders = snapshot.docs.map(doc=>{
      const data = doc.data();
      return {
        id: doc.id,
        ...data,
        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(0)
      };
    });

    orders.sort((a,b)=>b.createdAt - a.createdAt);

    const filtered = orders.filter(o => {
      if(activeTab === 'aktif') return o.status === 'Dibuat';
      if(activeTab === 'diproses') return o.status === 'Diproses';
      // riwayat
      return o.status === 'Selesai' || o.status === 'Dibatalkan';
    });

    if(filtered.length===0){
      container.innerHTML = "<p>Tidak ada pesanan.</p>";
      return;
    }

    container.innerHTML = '';
filtered.forEach(order=>{
  let statusClass = '';
  switch(order.status){
    case 'Dibuat': statusClass = 'proses'; break;
    case 'Diproses': statusClass = 'diproses'; break;
    case 'Selesai': statusClass = 'selesai'; break;
    case 'Dibatalkan': statusClass = 'gagal'; break;
    default: statusClass = 'proses';
  }

  const card = document.createElement('div');
  card.className = 'order-card';
  const createdTime = order.createdAt.getTime();
  const now = new Date().getTime();
  const canCancel = order.status === 'Dibuat' && (now - createdTime < 10 * 60 * 1000);

  // Tombol Batalkan hanya untuk status Dibuat
  const cancelButton = canCancel ? `<button onclick="confirmCancel('${order.id}')">Batalkan</button>` : '';

  // Tombol Chat Driver hanya untuk status Diproses
  const chatButton = order.status === 'Diproses' && order.kurir ? `
    <button onclick="chatDriver('${order.kurir}', '${order.id}')">Chat Driver</button>
  ` : '';

  card.innerHTML = `
    <div><b>${order.layanan || '-'}</b></div>
    <div>Pesanan: ${order.pesanan || '-'}</div>
    <div>Ongkir: Rp ${order.ongkir?.toLocaleString('id-ID') || '-'}</div>
    <div class="status ${statusClass}">${order.status}</div>
    <div style="font-size:12px;">${order.createdAt.toLocaleString("id-ID")}</div>
    <button onclick="showDetail('${order.id}')">Detail</button>
    ${cancelButton}
    ${chatButton}
  `;

  container.appendChild(card);
});

  }catch(e){
    container.innerHTML = "<p>Gagal memuat pesanan.</p>";
    console.log(e);
  }
}

async function chatDriver(kurirUid, orderId){
  if(!currentUser) return;

  const roomsRef = db.collection('chatRooms');
  let roomId = null;

  // Cari room yang sudah ada antara user dan kurir
  const snapshot = await roomsRef
    .where(`participants.${currentUser.uid}`, '==', true)
    .where(`participants.${kurirUid}`, '==', true)
    .get();

  if(!snapshot.empty){
    roomId = snapshot.docs[0].id; // pakai room pertama yang ketemu
  } else {
    // buat room baru
    const newRoom = await roomsRef.add({
      participants: {
        [currentUser.uid]: true,
        [kurirUid]: true
      },
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    roomId = newRoom.id;
  }

  // redirect ke chat
  window.location.href = `chat.html?roomId=${roomId}`;
}

function getStatusBadge(status){
  if(status==='Selesai') return `<span class="status-badge badge-selesai">SELESAI</span>`;
  if(status==='Dibatalkan') return `<span class="status-badge badge-gagal">DIBATALKAN</span>`;
  return `<span class="status-badge badge-proses">${status || 'PROSES'}</span>`;
}

function showDetail(orderId){
  const popup = document.getElementById('popupDetail');
  const popupContent = document.getElementById('popupContent');

  // Popup langsung muncul (no delay)
  popupContent.innerHTML = 'Memuat struk...';
  popup.classList.add('show');

  db.collection("orders").doc(orderId).get()
    .then(doc=>{
      if(!doc.exists) return;
      const data = doc.data();
      const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(0);

      popupContent.innerHTML = `
        <div class="receipt-header">
          <img src="logo.png" class="receipt-logo">
          <div class="receipt-title">SuruhBeli</div>
          <div class="receipt-sub">Struk Pesanan Digital</div>
        </div>

        <div class="row">
          <span class="label">ID Pesanan</span>
          <span class="value">#${doc.id.slice(0,6)}</span>
        </div>

        <div class="row">
          <span class="label">Waktu</span>
          <span class="value">${createdAt.toLocaleString("id-ID")}</span>
        </div>

        <div class="dash"></div>

        <div class="row">
          <span class="label">Layanan</span>
          <span class="value">${data.layanan || '-'}</span>
        </div>

        <div class="row">
          <span class="label">Pesanan</span>
          <span class="value">${data.pesanan || '-'}</span>
        </div>

        <div class="row">
          <span class="label">Beli di</span>
          <span class="value">${data.beliDi || '-'}</span>
        </div>

        <div class="row">
          <span class="label">Catatan</span>
          <span class="value">${data.catatan || '-'}</span>
        </div>

        <div class="dash"></div>

        <div class="row">
          <span class="label">Ongkir</span>
          <span class="value">Rp ${data.ongkir?.toLocaleString('id-ID') || '0'}</span>
        </div>

        <div class="row">
          <span class="label">Status</span>
          <span class="value">${getStatusBadge(data.status)}</span>
        </div>

        <div class="dash"></div>

        <div class="receipt-footer">
          Terima kasih telah menggunakan SuruhBeli
        </div>
      `;
    })
    .catch(err=>{
      popupContent.innerHTML = 'Gagal memuat struk.';
      console.log(err);
    });
}

function closePopup(){
  document.getElementById('popupDetail').classList.remove('show');
}
function showCustomPopup(message, isConfirm = false){
  return new Promise((resolve)=>{
    const popup = document.getElementById("popupAlert");
    const msg = document.getElementById("popupAlertMessage");
    const sub = document.getElementById("popupAlertSub");
    const btnOk = document.getElementById("popupOk");
    const btnCancel = document.getElementById("popupCancel");

    msg.textContent = message;

    if(isConfirm){
      sub.textContent = "Tindakan ini tidak bisa dibatalkan";
      btnCancel.style.display = "block";
    }else{
      sub.textContent = "";
      btnCancel.style.display = "none";
    }

    popup.classList.add("show");

    function close(result){
      popup.classList.remove("show");
      btnOk.onclick = null;
      btnCancel.onclick = null;
      resolve(result);
    }

    btnOk.onclick = ()=> close(true);
    btnCancel.onclick = ()=> close(false);
  });
}
// ---------- TAMBAHKAN DI SINI ----------
async function confirmCancel(orderId) {
  const yakin = await showCustomPopup(
    "Yakin ingin membatalkan pesanan?",
    true // ini mode confirm (ada tombol batal)
  );

  if (!yakin) return;

  try{
    await db.collection("orders").doc(orderId).update({
      status: "Dibatalkan"
    });

    await showCustomPopup("Pesanan berhasil dibatalkan!");
    loadOrders();

  }catch(err){
    console.log(err);
    await showCustomPopup("Gagal membatalkan pesanan!");
  }
}

//SINKRON TEMA 
function loadTheme(){
  const savedTheme = localStorage.getItem("themeMode");
  if(savedTheme === "dark"){
    document.body.classList.add("dark-mode");
  }else{
    document.body.classList.remove("dark-mode");
  }
}

// Jalankan saat halaman selesai load
window.addEventListener("load", loadTheme);

/* === NAVBAR BAWAH === */
const navItems = document.querySelectorAll('.nav-item');
const navCircle = document.getElementById('navCircle');
document.querySelector('.navbar-bottom')
  .classList.toggle('gempa-mode');
  
function updateNavCircle(activeIndex) {
  const activeItem = navItems[activeIndex];
  if (!activeItem || !navCircle) return;

  // Hitung posisi center ikon relatif ke navbar
  const navbarRect = activeItem.parentElement.getBoundingClientRect();
  const icon = activeItem.querySelector('svg');
  const iconRect = icon.getBoundingClientRect();

  const centerX = iconRect.left + iconRect.width / 2 - navbarRect.left;

  navCircle.style.left = `${centerX - navCircle.offsetWidth / 2}px`;
  navCircle.style.transform = 'scale(1.15)';

  setTimeout(() => {
    navCircle.style.transform = 'scale(1)';
  }, 200);
}

// Inisialisasi tab aktif sesuai URL
let currentPage = window.location.pathname.split("/").pop() || 'index.html';
navItems.forEach((item, idx) => {
  if (item.dataset.href === currentPage) {
    item.classList.add('active');
    updateNavCircle(idx);
  }

  // Event klik
  item.addEventListener('click', (e) => {
    e.preventDefault();
    navItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    updateNavCircle(idx);

    setTimeout(() => {
      window.location.href = item.dataset.href;
    }, 250); // animasi bulatan selesai dulu
  });
});

// Update posisi saat resize / load
function updateActiveCircle() {
  const active = document.querySelector('.nav-item.active');
  if (active) {
    const idx = Array.from(navItems).indexOf(active);
    updateNavCircle(idx);
  }
}

window.addEventListener('resize', updateActiveCircle);
window.addEventListener('load', updateActiveCircle);
</script>

</body>
</html>